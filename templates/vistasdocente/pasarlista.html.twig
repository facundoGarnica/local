{% extends 'base.html.twig' %}

{% block title %}Pasar Asistencia{% endblock %}

{% block body %}
<div id="PasarAsistenciaModal" class="AsistenciaModal1">
    <div id="alumno-container">
        <div class="alumno-card">
            <!-- Fecha con estilo profesional -->
            <div class="fecha-actual" id="fecha-actual"></div>

            <h2 class="alumno-nombre">Nombre Apellido</h2>
            <p class="alumno-dni">DNI: 12345678</p>
            <p id="estado">Estado: 
                <span class="estado-text estado-neutral">No marcado</span>
            </p>
            <p id="observacion" style="visibility: hidden;">
                Observaci√≥n: <input type="text" id="observacion-input" placeholder="Completar...">
            </p>
        </div>
    </div>

    <div class="botones mt-3">
        <button id="anterior">‚¨ÖÔ∏è Anterior</button>
        <button id="presente">‚úÖ Presente (F1)</button>
        <button id="ausente">‚ùå Ausente (F2)</button>
        <button id="mediafalta">‚è≥ Media falta (F3)</button>
        <button id="justificada">üìÑ‚úÖ Justificada (F4)</button>
        <button id="siguiente">Siguiente ‚û°Ô∏è</button>
    </div>
</div>

<script>
    // Obtener la fecha actual y mostrarla en el div
    const today = new Date();
    const day = String(today.getDate()).padStart(2, '0');
    const month = String(today.getMonth() + 1).padStart(2, '0'); // Enero es 0
    const year = today.getFullYear();
    const formattedDate = `Fecha: ${day}/${month}/${year}`;

    document.getElementById('fecha-actual').textContent = formattedDate;
    
        const cursadasData = [
            {% for cursada in cursadas %}
                {
                    id: {{ cursada.id }},
                    alumno: {
                        id: {{ cursada.alumno.id }},
                        nombre: "{{ cursada.alumno.nombre|e('js') }}",
                        apellido: "{{ cursada.alumno.apellido|e('js') }}",
                        dni: "{{ cursada.alumno.dniPasaporte|e('js') }}"
                    }
                }{% if not loop.last %},{% endif %}
            {% endfor %}
        ];
        console.log(cursadasData);

    
        let indiceActual = 0;
        let asistenciasMarcadas = {}; // para guardar temporalmente
    
        function mostrarAlumno(index) {
            if (index < 0 || index >= cursadasData.length) return;
    
            const alumno = cursadasData[index].alumno;
    
            document.querySelector('.alumno-nombre').textContent = `${alumno.nombre} ${alumno.apellido}`;
            document.querySelector('.alumno-dni').textContent = `DNI: ${alumno.dni}`;
            document.querySelector('.estado-text').textContent = 'No marcado';
            document.querySelector('.estado-text').className = 'estado-text estado-neutral';
            document.getElementById('observacion').style.visibility = 'hidden';
            document.getElementById('observacion-input').value = '';
    
            // Si ya se marc√≥ asistencia antes, mostrarla
            const previa = asistenciasMarcadas[alumno.id];
            if (previa) {
                actualizarEstado(previa.estado);
                if (previa.observacion) {
                    document.getElementById('observacion').style.visibility = 'visible';
                    document.getElementById('observacion-input').value = previa.observacion;
                }
            }
        }
    
        function actualizarEstado(estado) {
            const spanEstado = document.querySelector('.estado-text');
            spanEstado.textContent = estado;
    
            spanEstado.className = 'estado-text';
            spanEstado.classList.add('estado-' + estado.toLowerCase().replace(' ', ''));
    
            if (estado === 'Justificada') {
                document.getElementById('observacion').style.visibility = 'visible';
            } else {
                document.getElementById('observacion').style.visibility = 'hidden';
            }
    
            // Guardar temporalmente
            const alumnoId = cursadasData[indiceActual].alumno.id;
            asistenciasMarcadas[alumnoId] = {
                estado: estado,
                observacion: document.getElementById('observacion-input').value || ''
            };
        }
    
        document.getElementById('anterior').addEventListener('click', () => {
            if (indiceActual > 0) {
                indiceActual--;
                mostrarAlumno(indiceActual);
            }
        });
    
        document.getElementById('siguiente').addEventListener('click', () => {
            if (indiceActual < cursadasData.length - 1) {
                indiceActual++;
                mostrarAlumno(indiceActual);
            }
        });
    
        document.getElementById('presente').addEventListener('click', () => actualizarEstado('Presente'));
        document.getElementById('ausente').addEventListener('click', () => actualizarEstado('Ausente'));
        document.getElementById('mediafalta').addEventListener('click', () => actualizarEstado('Media falta'));
        document.getElementById('justificada').addEventListener('click', () => actualizarEstado('Justificada'));
    
        document.addEventListener('DOMContentLoaded', () => {
            mostrarAlumno(indiceActual);
        });
    </script>
{% endblock %}
